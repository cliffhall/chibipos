{"version":3,"file":"_server-CMySrksN.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/update-sales/_server.js"],"sourcesContent":["import { Op, Sequelize } from \"sequelize\";\nimport { j as json } from \"../../../../chunks/index.js\";\nimport { s as sequelize } from \"../../../../chunks/catProduct.js\";\nimport { P as Product } from \"../../../../chunks/product.js\";\nimport { T as Ticket, a as TicketDetails } from \"../../../../chunks/ticketDetails.js\";\nimport { D as DailySales, a as DailySalesDetails } from \"../../../../chunks/daily_salesDetails.js\";\nasync function GET({ url }) {\n  const transaction = await sequelize.transaction();\n  try {\n    const date = url.searchParams.get(\"date\");\n    const start = new Date(date);\n    start.setUTCHours(6, 0, 0, 0);\n    const end = new Date(date);\n    end.setUTCDate(end.getUTCDate() + 1);\n    end.setUTCHours(5, 59, 59, 999);\n    let startISO = start.toISOString();\n    let endISO = end.toISOString();\n    const canceledTickets = await Ticket.findAll({\n      attributes: [\n        [Sequelize.fn(\"COUNT\", Sequelize.col(\"ticket.id\")), \"canceled_count\"]\n      ],\n      where: {\n        date: { [Op.between]: [startISO, endISO] },\n        canceled: true\n      },\n      raw: true,\n      transaction\n    });\n    const validTickets = await Ticket.findAll({\n      attributes: [\n        [Sequelize.fn(\"COUNT\", Sequelize.col(\"ticket.id\")), \"ticket_count\"],\n        [Sequelize.fn(\"SUM\", Sequelize.col(\"ticket.cash\")), \"sum_cash\"],\n        [Sequelize.fn(\"SUM\", Sequelize.col(\"ticket.card\")), \"sum_card\"]\n      ],\n      where: {\n        date: { [Op.between]: [startISO, endISO] },\n        canceled: false\n      },\n      raw: true,\n      transaction\n    });\n    const lineItems = await TicketDetails.findAll({\n      attributes: [\n        \"product_id\",\n        [Sequelize.fn(\"SUM\", Sequelize.col(\"ticket_details.quantity\")), \"sum_quantity\"],\n        [Sequelize.fn(\"SUM\", Sequelize.col(\"ticket_details.extended_price\")), \"sum_extended_price\"],\n        [Sequelize.fn(\"SUM\", Sequelize.col(\"ticket_details.discount_amount\")), \"sum_discount_amount\"],\n        [Sequelize.fn(\"SUM\", Sequelize.literal(\"ticket_details.price * ticket_details.quantity\")), \"sum_total_sale\"]\n      ],\n      include: [\n        {\n          model: Ticket,\n          attributes: [],\n          where: {\n            date: { [Op.between]: [startISO, endISO] },\n            canceled: false\n          }\n        },\n        {\n          model: Product,\n          attributes: [\"id\", \"name\"]\n        }\n      ],\n      group: [\"product_id\", \"Product.id\"],\n      raw: true,\n      transaction\n    });\n    const netSales = lineItems.reduce((sum, item) => sum + parseFloat(item.sum_extended_price), 0);\n    const totalSales = lineItems.reduce((sum, item) => sum + parseFloat(item.sum_total_sale), 0);\n    const discountAmount = lineItems.reduce((sum, item) => sum + parseFloat(item.sum_discount_amount), 0);\n    const totalCash = validTickets.reduce((sum, ticket) => sum + parseFloat(ticket.sum_cash), 0);\n    const totalCard = validTickets.reduce((sum, ticket) => sum + parseFloat(ticket.sum_card), 0);\n    const ticketCount = validTickets[0].ticket_count;\n    const canceledCount = canceledTickets[0]?.canceled_count || 0;\n    const dailySale = await DailySales.create({\n      date,\n      net_sales: netSales,\n      total_sales: totalSales,\n      cash: totalCash,\n      card: totalCard,\n      ticket_count: ticketCount,\n      canceled_count: canceledCount,\n      average_ticket: Math.round(netSales / ticketCount),\n      discount_amount: discountAmount\n    }, { transaction });\n    const saleDetails = lineItems.map((item) => ({\n      date,\n      daily_sales_id: dailySale.id,\n      product_id: item.product_id,\n      quantity: item.sum_quantity,\n      net_sales: item.sum_extended_price,\n      av_price: Math.round(item.sum_extended_price / item.sum_quantity),\n      discount_amount: item.sum_discount_amount\n    }));\n    await DailySalesDetails.bulkCreate(saleDetails, { transaction });\n    await transaction.commit();\n    return json({ dailySale });\n  } catch (error) {\n    console.error(\"error on sales report: \", error);\n    await transaction.rollback();\n    return json({ status: 500 });\n  }\n}\nexport {\n  GET\n};\n"],"names":[],"mappings":"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"}