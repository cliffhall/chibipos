{"version":3,"file":"_server-2kavG7km.js","sources":["../../../.svelte-kit/adapter-node/entries/endpoints/api/ticket/_server.js"],"sourcesContent":["import { j as json } from \"../../../../chunks/index.js\";\nimport { Op } from \"sequelize\";\nimport { s as sequelize } from \"../../../../chunks/catProduct.js\";\nimport { P as Product } from \"../../../../chunks/product.js\";\nimport { T as Ticket, a as TicketDetails } from \"../../../../chunks/ticketDetails.js\";\nasync function GET({ url }) {\n  const date = url.searchParams.get(\"date\");\n  try {\n    let tickets;\n    if (date) {\n      const start = new Date(date);\n      start.setUTCHours(6, 0, 0, 0);\n      const end = new Date(date);\n      end.setUTCDate(end.getUTCDate() + 1);\n      end.setUTCHours(5, 59, 59, 999);\n      let startISO = start.toISOString();\n      let endISO = end.toISOString();\n      tickets = await Ticket.findAll({\n        where: {\n          date: {\n            [Op.between]: [startISO, endISO]\n          }\n        },\n        attributes: { exclude: [\"createdAt\", \"updatedAt\"] },\n        order: [[\"date\", \"DESC\"]]\n      });\n    } else {\n      tickets = await Ticket.findAll({\n        attributes: { exclude: [\"createdAt\", \"updatedAt\"] }\n      });\n    }\n    return json(tickets);\n  } catch (error) {\n    console.error(\"get tickets error\", error);\n    return { status: 500 };\n  }\n}\nasync function POST({ request }) {\n  const saleData = await request.json();\n  const { cash, card, discountRate, frontendTotal, products, cashReceived, change } = saleData;\n  const date = (/* @__PURE__ */ new Date()).toISOString();\n  if (!date || !products || !Array.isArray(products)) {\n    return { error: \"Invalid data\" };\n  }\n  if (discountRate > 1 || discountRate < 0) {\n    return { error: \"Invalid data\" };\n  }\n  if (cash + card < frontendTotal) {\n    return { error: \"Invalid data\" };\n  }\n  try {\n    let ticket;\n    let ticketDetails;\n    let subtotal = 0;\n    let discountAmount = 0;\n    let totalAmount = 0;\n    await sequelize.transaction(async (transaction) => {\n      const productPrices = await Promise.all(\n        products.map(async (product) => {\n          const { product_id, quantity } = product;\n          if (quantity < 0) {\n            throw new Error(`invalid product quantity`);\n          }\n          const existingProduct = await Product.findByPk(product_id, { transaction });\n          if (!existingProduct) {\n            throw new Error(`product does not exist`);\n          }\n          subtotal += existingProduct.price * quantity;\n          return existingProduct.price;\n        })\n      );\n      if (discountRate && discountRate > 0) {\n        discountAmount = subtotal * discountRate;\n      }\n      totalAmount = subtotal - discountAmount;\n      const frontBackTotalDifference = frontendTotal - totalAmount;\n      console.log(`Total difference: ${frontBackTotalDifference}`);\n      if (Math.abs(frontBackTotalDifference) > 0.1) {\n        return json({ error: \"Frontend and backend totals do not match\" }, { status: 400 });\n      }\n      ticket = await Ticket.create({\n        date,\n        cash,\n        card,\n        cash_received: cashReceived,\n        change,\n        subtotal,\n        total_amount: totalAmount,\n        discount_rate: discountRate,\n        discount_amount: discountAmount,\n        canceled: false\n      }, { transaction });\n      await Promise.all(\n        products.map(async (product, index) => {\n          const { product_id, quantity } = product;\n          const unitPrice = productPrices[index];\n          const discountAmount2 = unitPrice * quantity * discountRate;\n          const extendedPrice = unitPrice * quantity - discountAmount2;\n          await TicketDetails.create({\n            ticket_id: ticket.id,\n            product_id,\n            quantity,\n            price: unitPrice,\n            extended_price: extendedPrice,\n            discount_amount: discountAmount2\n          }, { transaction });\n        })\n      );\n      ticketDetails = await TicketDetails.findAll({\n        where: { ticket_id: ticket.id },\n        include: {\n          model: Product,\n          attributes: [\"name\"]\n          // Include only product name\n        },\n        transaction\n      });\n    });\n    return json({ ticket, ticketDetails, status: 200 });\n  } catch (error) {\n    console.error(\"post ticket error\", error);\n    return { status: 500 };\n  }\n}\nasync function DELETE() {\n  console.log(\"delete tickets\");\n  try {\n    await TicketDetails.destroy({\n      truncate: true\n    });\n    await Ticket.destroy({\n      truncate: true,\n      cascade: true\n    });\n  } catch (error) {\n    console.error(\"error deleting: \", error);\n    return json({ status: 500 });\n  }\n}\nasync function PATCH({ request }) {\n  try {\n    const tickets = await Ticket.findAll();\n    tickets.forEach((ticket) => {\n      console.log(\"ticket.date: \", ticket.date);\n    });\n    for (const ticket of tickets) {\n      if (ticket.date) {\n        const date = new Date(ticket.date);\n        date.setDate(date.getDate() - 1);\n        await ticket.update({ date: date.toISOString() });\n      }\n    }\n    return json({ status: 200, message: \"ticket dates updated succesfully\" });\n  } catch (error) {\n    console.error(\"error patching tickets\", error);\n    return json({ status: 500 });\n  }\n}\nexport {\n  DELETE,\n  GET,\n  PATCH,\n  POST\n};\n"],"names":[],"mappings":"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"}